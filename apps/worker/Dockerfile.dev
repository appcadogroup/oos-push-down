# --- builder
FROM node:22-bullseye AS builder
WORKDIR /app

# 1) Seed npm cache layers with only manifests
COPY package.json ./
COPY apps/backend/package.json apps/backend/
COPY packages/db/package.json packages/db/
COPY packages/redis/package.json packages/redis/
COPY packages/core/package.json packages/core/
COPY packages/queue/package.json packages/queue/
COPY packages/shopify-auth/package.json packages/shopify-auth/

# copy prisma schema early so postinstall can find it
COPY packages/db/prisma packages/db/prisma

# 2) Install full deps for build/gen (workspace-aware)
RUN NODE_ENV=development npm install --workspaces --include=dev && npm --global install nodemon

# 3) Copy source
COPY . .

# 3) Runtime
ENV WORKER_PORT=3100
EXPOSE 3100

# # Healthcheck hits your queue health route (from initWorkers)
# HEALTHCHECK --interval=15s --timeout=5s --retries=5 CMD curl -sf http://localhost:3100/health/queue/ready || exit 1

# Start the workerâ€™s tiny health server entrypoint
CMD ["npm", "run", "dev:worker"]